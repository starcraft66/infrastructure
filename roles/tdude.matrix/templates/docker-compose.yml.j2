version: '2.3'
services:
  synapse:
    container_name: matrix_synapse
    image: matrixdotorg/synapse:{{ matrix_synapse_version }}
    volumes:
      - {{ matrix_synapse_data_folder }}:/data
    environment:
      UID: 927
      GID: 927
      TZ: "Europe/Paris"
      SYNAPSE_CACHE_FACTOR: 10.0
      SYNAPSE_CONFIG_PATH: "/data/homeserver.yaml"
    networks:
      monitoring:
      matrix:
        ipv4_address: "10.72.128.4"
        ipv6_address: "2607:5300:60:873e:7::4"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "50m"
  postgres:
    container_name: matrix_postgres
    image: postgres:{{ matrix_postgres_version }}
    volumes:
      - {{ matrix_postgres_data_folder }}:/var/lib/postgresql/data
    restart: unless-stopped
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: {{ matrix_synapse_postgres_db }}
      POSTGRES_USER: {{ matrix_synapse_postgres_user }}
      POSTGRES_PASSWORD: {{ matrix_synapse_postgres_password }}
    networks:
      matrix:
        ipv4_address: "10.72.128.3"
        ipv6_address: "2607:5300:60:873e:7::3"
  appservice_webhooks:
    user: "927:927"
    container_name: matrix_appservice_webhooks
    image: starcraft66/matrix-appservice-webhooks:{{ matrix_appservice_webhooks_version }}
    volumes:
      - "{{ matrix_appservice_webhooks_data_folder }}:/data"
    restart: unless-stopped
    networks:
      matrix:
        ipv4_address: "10.72.128.5"
        ipv6_address: "2607:5300:60:873e:7::5"
  nginx_riot:
    container_name: matrix_nginx
    image: bubuntux/riot-web:{{ matrix_synapse_version }}
    volumes:
      - "{{ matrix_riot_data_folder }}/config.json:/etc/riot-web/config.json:ro"
      - "{{ matrix_riot_usercontent_folder }}:/usr/share/nginx/html/usercontent:ro"
      - "{{ matrix_nginx_data_folder }}/matrix.conf:/etc/nginx/conf.d/default.conf:ro"
      #- "{{ matrix_riot_data_folder }}/dhparam.pem:/etc/nginx/dhparam.pem:ro"
    networks:
      matrix:
        ipv4_address: 10.72.128.6
        ipv6_address: "2607:5300:60:873e:7::6"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "50m"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.matrix.loadbalancer.server.port=80"
      - "traefik.docker.network=matrix_matrix"
      - "traefik.http.routers.matrix.rule=Host(`nerdsin.space`,`usercontent.nerdsin.space`)"
      - "traefik.http.routers.matrix.entryPoints=web,web-secure"
      - "traefik.http.routers.matrix.middlewares=https@file"
      - "traefik.http.routers.matrix.tls=true"
      - "traefik.http.routers.matrix.tls.certresolver=le"
  minio:
    container_name: matrix_minio
    image: minio/minio:{{ matrix_minio_version }}
    command: minio gateway b2
    environment:
      MINIO_ACCESS_KEY: "{{ matrix_minio_b2_account_id }}"
      MINIO_SECRET_KEY: "{{ matrix_minio_b2_application_key }}"
    networks:
      matrix:
        ipv4_address: 10.72.128.7
        ipv6_address: "2607:5300:60:873e:7::7"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "50m"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.matrix-minio.loadbalancer.server.port=9000"
      - "traefik.docker.network=matrix_matrix"
      - "traefik.http.routers.matrix-minio.rule=Host(`minio.nerdsin.space`)"
      - "traefik.http.routers.matrix-minio.entryPoints=web,web-secure"
      - "traefik.http.routers.matrix-minio.middlewares=https@file,fwauth@file"
      - "traefik.http.routers.matrix-minio.tls=true"
      - "traefik.http.routers.matrix-minio.tls.certresolver=le"

networks:
  monitoring:
    external:
      name: monitoring
  matrix:
    #name: matrix
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-matrix
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.72.128.0/24
          gateway: 10.72.128.1
        - subnet: "2607:5300:60:873e:7::/80"
          gateway: "2607:5300:60:873e:7::1"
