version: '2.3'
services:
  traefik:
    image: traefik:{{ traefik_docker_version }}
    container_name: traefik
    restart: unless-stopped
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "{{ traefik_data_folder }}/traefik.toml:/traefik.toml"
      - "{{ traefik_data_folder }}/acme.json:/acme.json"
    ports:
      - "62.210.251.78:80:80"
      - "62.210.251.78:443:443"
      # 2001:bc8:2517:100::3 is still required until I figure out a fix for the gitlab ssh port
      - "2001:bc8:2517:100::3:80:80"
      - "2001:bc8:2517:100::3:443:443"

    labels:
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:monitor.plank.tdude.co"
      - "traefik.port=8081"
{{ traefik_sts_header_labels }}
# Commented out for the moment because the docker socket
# requires root access. Simply granting the traefik user
# access to the docker group appears not to be enough.
# Will have to look into exposing the docker daemon via
# TLS.
#    user: "939:939"
    environment:
      CF_API_EMAIL: {{ dehydrated_lexicon_dns["LEXICON_CLOUDFLARE_USERNAME"] }}
      CF_API_KEY: {{ dehydrated_lexicon_dns["LEXICON_CLOUDFLARE_TOKEN"] }}
    networks:
      traefik:
        ipv4_address: 10.44.0.2
        ipv6_address: "2001:bc8:2517:122::2"
      matrix:
      monitoring:
      mediaserver:
      status:
      gitlab:
      traefik:
      lolisafe:
      {{ elk_docker_network }}:

  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    container_name: traefik-forward-auth
    environment:
      PROVIDERS_GOOGLE_CLIENT_ID: {{ traefik_oauth2_client_id }}
      PROVIDERS_GOOGLE_CLIENT_SECRET: {{ traefik_oauth2_client_secret }}
      SECRET: {{ traefik_oauth2_secret }}
      INSECURE_COOKIE: "false"
      COOKIE_DOMAINS: plank.tdude.co
      WHITELIST: starcraft66@gmail.com
      AUTH_HOST: auth.plank.tdude.co
    networks:
      traefik:
        ipv4_address: 10.44.0.3
        ipv6_address: "2001:bc8:2517:122::3"
    labels:
      - traefik.enable=true
      - traefik.port=4181
      - traefik.backend=traefik-forward-auth
      - traefik.backend.network=traefik
      - traefik.frontend.rule=Host:auth.plank.tdude.co
{{ traefik_sts_header_labels }}
{{ traefik_forward_auth_labels }}

networks:
  traefik:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-traefik
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.44.0.0/24
          gateway: 10.44.0.1
        - subnet: "2001:bc8:2517:122::/64"
          gateway: "2001:bc8:2517:122::1"
  matrix:
    external:
      name: matrix_matrix
  lolisafe:
    external:
      name: lolisafe
  monitoring:
    external:
      name: monitoring
  mediaserver:
    external:
      name: mediaserver
  status:
    external:
      name: status
  gitlab:
    external:
      name: gitlab
  {{ elk_docker_network }}:
    external:
      name: {{ elk_docker_network }}