- name: Install calicoctl
  get_url:
    url: "https://github.com/projectcalico/calicoctl/releases/download/v{{ calicoctl_version }}/calicoctl"
    dest: /usr/local/bin/calicoctl
    mode: '0755'

- name: Download calico kubernetes manifest
  get_url:
    url: "https://docs.projectcalico.org/manifests/calico.yaml"
    dest: /tmp/calico.yaml
    mode: '0660'

- name: Patch the calico manifest to our liking
  patch:
    src: calico.yaml.patch
    dest: /tmp/calico.yaml

- name: Install calicoctl config
  copy:
    src: calicoctl.cfg
    dest: /etc/calico/calicoctl.cfg
    mode: "0640"

- name: Copy calico ippool config
  template:
    src: calico-ippool.yaml.j2
    dest: /tmp/ippool.yaml
    mode: "0640"

- name: Copy calico bgp config
  template:
    src: calico-bgp.yaml.j2
    dest: /tmp/bgp.yaml
    mode: "0640"

- name: Apply calico kubernetes manifest
  shell: "kubectl apply -f /tmp/calico.yaml"

- name: Wait a bit for good measure
  pause:
    seconds: "10"

- name: Apply calico bgp manifest
  shell: "calicoctl create -f /tmp/bgp.yaml"

- name: Delete calico default IPv6 IP pool
  shell: "calicoctl delete ippools default-ipv6-ippool"

- name: Apply good calico IPv6 IP pool
  shell: "calicoctl create -f /tmp/ippool.yaml"